# FreshRSS 文章总结插件

- [English README](README.md)

这个 FreshRSS 插件允许用户使用符合 OpenAI API 规范的语言模型 API 来生成文章摘要。该插件提供了一个用户友好的界面来配置 API 端点、API 密钥、模型名称和一个在内容之前添加的提示。激活后，它会在每篇文章中添加一个“总结”按钮，点击后会将文章内容发送到配置的 API 进行总结。

## 功能

- **多API提供商支持**：支持 OpenAI 和 Ollama API 提供商，提供最大的灵活性。
- **API 配置**：通过简单的表单轻松配置基础 URL、API 密钥、模型名称和提示。
- **总结按钮**：为每篇文章添加一个“总结”按钮，用户只需点击即可生成摘要。
- **Markdown 支持**：在发送内容到 API 之前，将 HTML 内容转换为 Markdown，确保与各种语言模型的兼容性。
- **流式响应**：在从 API 接收摘要结果时实时处理并显示。
- **自动 API 版本处理**：如果缺少 API 版本路径，会自动将适当的版本路径（例如 `/v1`）添加到基础 URL。
- **增强的错误处理**：在 API 错误或配置不完整的情况下提供详细的错误信息。
- **内容安全策略**：配置为允许向外部端点发送 API 请求。
- **国际化支持**：支持英语、简体中文 (zh-CN) 和繁体中文 (zh-TW) 三种语言显示。
- **默认提示词和占位符**：如果未设置自定义提示词，提供语言特定的默认提示词和输入框占位符。

## 安装

1. **下载插件**：将此仓库克隆或下载到您的 FreshRSS 扩展目录。
2. **启用插件**：进入 FreshRSS 扩展管理页面，启用 "ArticleSummary" 插件。
3. **配置插件**：导航到插件的配置页面，设置您的 API 详细信息。

## 配置

要配置插件，请按照以下步骤操作：

1. **基础 URL**：输入您的语言模型 API 的基础 URL（例如，`https://api.openai.com/`）。注意，URL 不应包含版本路径（例如，`/v1`）。
2. **API 密钥**：提供您的 API 密钥用于身份验证。
3. **模型名称**：指定您希望用于总结的模型名称（例如，`gpt-3.5-turbo`）。
4. **提示**：添加一个提示，该提示将在发送请求到 API 时包含在文章内容之前。

## 使用

配置完成后，插件会自动为每篇文章添加一个“总结”按钮。点击此按钮将：

1. 将文章内容发送到配置的 API。
2. 在按钮下方显示生成的摘要。

## 依赖

- **Axios**：用于从浏览器发出 HTTP 请求。
- **Marked**：将 Markdown 内容转换为 HTML 以便显示。

## 开发

### 运行测试

此插件包含自动化测试以确保代码质量。要运行测试：

```bash
# 安装依赖
composer install

# 运行 PHPUnit 测试
composer test

# 运行 PHPStan 静态分析
composer phpstan

# 同时运行测试和静态分析
composer ci
```

### 代码质量

该插件遵循现代 PHP 标准并包括：
- **类型声明**：所有方法都有适当的类型提示
- **Final 类**：类被标记为 `final` 以防止继承
- **静态分析**：PHPStan 配置用于检测潜在问题
- **自动化测试**：PHPUnit 测试套件用于核心功能

### 现代 PHP 特性

该插件已升级以使用现代 FreshRSS API：
- 使用基于字符串的钩子（`'entry_before_display'`）以确保与旧版本 FreshRSS 的向后兼容性
- 所有方法和参数都有适当的类型声明
- 使用 `ob_start()` 处理 JSON API 响应，防止"headers already sent"错误
- 遵循 FreshRSS 扩展开发最佳实践

**关于 `ob_start()` 的重要说明**：
`summarizeAction()` 中的 `ob_start()` 调用**不是过时的**，而是对于 JSON API 响应**必不可少的**。它通过在设置标头之前缓冲输出来防止"Cannot modify header information - headers already sent"错误。这是 FreshRSS 扩展中返回 JSON 响应的控制器标准做法。

## 贡献

欢迎贡献！请随时提交问题或拉取请求。

在贡献时，请确保：
1. 所有测试通过：`composer test`
2. 静态分析通过：`composer phpstan`
3. 代码遵循现有的风格和约定
4. 新功能包含适当的测试

## 许可证

本项目基于 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 致谢

- 感谢 FreshRSS 社区提供了一个强大的 RSS 管理平台。
- 灵感来自于对高效文章总结工具的需求。

## 历史
- 版本: 0.5.2 (2026-01-13)
  > **Bug 修复**：修复了删除旧提示词后不会恢复默认提示词的问题
  > - 添加了提交空字符串时将提示词设置为 null 的逻辑
  > - 确保用户清空提示词字段时应用默认提示词

- 版本: 0.5.1 (2026-01-13)
  > **Bug 修复**：修复了提示词设置无法正确保存的问题
  > - 将默认提示词逻辑从 `empty()` 检查改为 `is_null()` 检查
  > - 确保空提示词可以被正确保存和使用
  > - 清理了调试代码并优化了配置处理

- 版本: 0.5.0 (2026-01-08)
  > **代码质量改进**: 
  > - 为所有方法和参数添加了类型声明
  > - 将类标记为 `final` 以防止继承
  > - 添加了 PHPStan 配置用于静态分析
  > - 添加了包含基本测试的 PHPUnit 测试套件
  > - 更新了 `.gitignore` 以改善项目卫生
  > - 改进了代码文档和注释
  > - **修复**：恢复为基于字符串的钩子以确保与旧版本 FreshRSS 的兼容性
  > - **修复**：在 `summarizeAction()` 中恢复 `ob_start()` - 对于 JSON API 响应是必不可少的，用于防止"headers already sent"错误

- 版本: 0.4.0 (2026-01-08)
  > **新增功能**: 
  > - 为OpenAI API添加了流式响应支持，与Ollama API保持一致

- 版本: 0.3.0 (2026-01-08)
  > **新增功能**: 
  > - 实现了国际化（i18n）支持
  > - 添加了英语、简体中文 (zh-CN) 和繁体中文 (zh-TW) 翻译
  > - 更新了语言代码结构，遵循国际标准
  > - 所有界面元素现在支持动态语言切换
  > - 添加了默认提示词和占位符功能，提供语言特定的默认提示

- 版本: 0.2.0 (2025-01-08)
  > **新增功能**: 
  > - 增加了对 Ollama API 提供商的支持
  > - 实现了流式响应处理，用于实时显示摘要
  > - 增强了错误处理，提供详细的错误信息
  > - 添加了自动 API 版本处理
  > - 改进了从 HTML 到 Markdown 的内容转换
  > - 更新了内容安全策略配置

- 版本: 0.1.1 (2024-11-20)
  > **Bug 修复**: 防止总结按钮影响标题列表显示。之前，'entry_before_display' 钩子导致总结按钮被添加到标题列表中，导致显示问题。现在，按钮初始时没有文字，只有在点击文章显示时才会添加文字。

---

如有任何问题或需要支持，请在此仓库中打开一个 issue。